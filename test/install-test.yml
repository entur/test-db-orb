version: 2.1

#Include this in your config.yml
#orbs:
#  test-db: entur/test-db@dev:refactor-test-db # Use volatile if you always want the newest version.

#executors:
#  entur-cci-toolbox: test-db/entur-cci-toolbox

jobs:
  test-test-db-orb:
    docker:
      - image: entur/cci-toolbox:2.1
    steps:
      - checkout
      - test-db/mysql-start:
          mysql-version: "8"
          sql-file: ./test/all_db.sql
          checksum: sql-{{ checksum "./test/all_db.sql" }}
          database-name: testdb
          mysql-user: dbuser
          mysql-password: dbpword
          root-password: root
          server-name: test-db
      #- setup_remote_docker:
      #    docker_layer_caching: true
      - run: echo $TEST_DB_DOCKER_NAME
      - run: docker run --rm mysql-client mysql --host=test-db --user=root --password=root --database=testdb --execute='show tables;'

workflows:
  version: 2.1
  main:
    jobs:
      - test-test-db-orb:
          name: build #must be called build for the test to be run
